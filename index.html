<!DOCTYPE html>
<html>
    <head>

        <!-- script de A-Frane version1 1.0.0 -->
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <!-- script de AR.JS con soporte de marker + location -->
        <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
       
        <script src="https://unpkg.com/aframe-frustum-lock-component"></script>
        <script>
          aframeFrustumLockComponent(window.AFRAME);
        </script>
        <script>
            AFRAME.registerComponent("listener", {
        init: function() {
            this.target = document.querySelector('#marker'); // your video
            this.prevPosition = null; // initially there is no position or rotation
            this.prevRotation = null;
        },

        tick: function() {
            if (this.el.object3D.visible) {
            this.target.setAttribute('visible', 'true')

            if(!this.prevPosition && !this.prevRotation) { 
                // there are no values to lerp from - set the initial values
                this.target.setAttribute('position', this.el.getAttribute('position'))
                this.target.setAttribute('rotation', this.el.getAttribute('rotation'))
            } else {
                // use the previous values to get an approximation 
                this.target.object3D.position.lerp(this.prevPosition, 0.1)

                // this (below) may seem ugly, but the rotation is a euler, not a THREE.Vector3, 
                // so to use the lerp function i'm doing some probably unnecessary conversions
                let rot = this.target.object3D.rotation.toVector3().lerp(this.prevRotation, 0.1)
                this.target.object3D.rotation.setFromVector3(rot)
            }
            // update the values
            this.prevPosition = this.el.object3D.position
            this.prevRotation = this.el.object3D.rotation
            } else {
            // the marker dissapeared - reset the values
            this.target.setAttribute('visible', 'false')
            this.prevPosition = null;
            this.prevRotation = null;
        }
        }
        })
        </script>
        <script>
            var detectedQR = false;
            var lastPosition;
            var lastRotation;
            AFRAME.registerComponent("markercomp", {
                init: function () {
                    var marker = document.querySelector("#marker");
                    marker.addEventListener("markerFound", function () {
                            console.log("MARKER DETECTED");
            
                         //displayEntity("#pallet","#marker");
                         
                     
                            
                    });

                    marker.addEventListener("markerLost", function () {
                            console.log("MARKER LOST");
                          //  removeEntity("#pallet");
                    });
                
            
                }
            });

            AFRAME.registerComponent("rotationcomp", {
                tick: function () {
                    var model = document.querySelector("#pallet");
                    model.setAttribute("rotation",{x:0,y:0,z:0});
            
                }
            });

    /*        AFRAME.registerComponent("move", {
                tick: function() {
                    let obj3d = document.querySelector("#marker");
                     console.log("ENCONTRADO MARKER TRACKING" + obj3d);
                    this.el.object3D.setRotationFromQuaternion(obj3d.object3D.quaternion);
                    this.el.object3D.position.set(obj3d.object3D.position.x, obj3d.object3D.position.y, obj3d.object3D.position.z);
                }
            });*/

            function displayEntity(e_id,m_id) {

                
                var el = document.querySelector(e_id);
                
                if(!detectedQR){
                    el.setAttribute("visible", true);
                    detectedQR=true;
                } 
                
                var mel = document.querySelector(m_id);
                lastPosition = mel.getAttribute("position");
                lastRotation = mel.getAttribute("rotation");
                
                el.setAttribute("position",lastPosition);
                el.setAttribute("rotation",lastRotation);
                console.log("AYAYAYAYYA"+lastPosition.x);
                
                //let obj3d = document.querySelector("#marker");
                //el.object3D.setRotationFromQuaternion(obj3d.object3D.quaternion);
                //el.object3D.position.set(obj3d.object3D.position.x, obj3d.object3D.position.y, obj3d.object3D.position.z);
                //var m_position = mel.getAttribute("position");
                //el.setAttribute("position",{x:obj3d.x,y:obj3d.y,z:obj3d.z});
                
            }
            

           function removeEntity(e_id) {
                var el = document.querySelector(e_id);
                el.setAttribute("position",lastPosition);
                el.setAttribute("rotation",lastRotation);
                el.setAttribute("visible", true);           
               // console.log("NONONONONO" );
            }

        </script>

    </head>
    <body style="margin : 0px; overflow: hidden;">

        
        <a-scene embedded arjs="debugUIEnabled: false" 
        renderer="logarithmicDepthBuffer: true;"
        trackingMethod= "best" vr-mode-ui="enabled: false">        
            
            <a-assets>
                <a-asset-item id="3dmodel" src="scene.gltf"></a-asset-item>
                <img id="logo_img" src="logo_telecmotica.png">
            </a-assets>

            <a-plane position= "0 0 0" static-body id="pivot" rotation="90 0 0 "></a-plane>
            <a-entity gltf-model="#3dmodel" id="pallet" look-controls listener
            scale="0.1 0.1 0.1"
            visible="true"
            static-body
            constraint="target: #pivot;"
            
            >
            </a-entity>
            <a-image id="logo"
            position="0 3 0"
            scale="1 1 2"
            animation="property: rotation; dur: 15000; to: 0 360 0; loop: true"
            look-at="#marker"
            src="#logo_img">
            </a-image>
            
            <a-marker-camera markercomps smooth="true"
            markerhandler emitevents="true"
            id="marker" camera="far:100000; near:0.01"
            preset="custom" type="pattern" url="custom.patt">

                        
            
            

        </a-marker>
        
       
        
        </a-scene>

    </body>
</html>